# üì¶ –ü–ª–∞–Ω —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ `signals_v4_main.py`

---

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–ù–æ–≤—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—Ö–æ–¥—è—â–∏—Ö —Å–∏–≥–Ω–∞–ª–æ–≤, –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ Redis Stream `signals_stream`, —Å –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–µ–π –ø–æ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è–º –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º –≤ PostgreSQL.

---

## üîπ –≠–¢–ê–ü 1: –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø

### ‚úÖ 1.1. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Redis –∏ PostgreSQL
- [ ] –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `infra.py`:
  - `init_pg_pool()`
  - `init_redis_client()`
  - `run_safe_loop()`

### ‚úÖ 1.2. –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Å–ª–æ–≤–∞—Ä–∏
- [ ] `TICKERS = {}` ‚Äî –∞–∫—Ç–∏–≤–Ω—ã–µ —Ç–∏–∫–µ—Ä—ã
- [ ] `STRATEGIES = {}` ‚Äî –∞–∫—Ç–∏–≤–Ω—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
- [ ] `STRATEGY_SIGNALS = {}` ‚Äî —Ñ—Ä–∞–∑—ã ‚Üí —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏

---

## üîπ –≠–¢–ê–ü 2: –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–•

- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `load_tickers()`, `load_strategies()`, `load_strategy_signals()`
- [ ] –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
- [ ] –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π swap: `.clear(); .update(...)`

---

## üîπ –≠–¢–ê–ü 3: REDIS STREAM (–ü–û–î–ü–ò–°–ö–ê)

### ‚úÖ 3.1. Stream: `signals_stream`
- [ ] –°–æ–∑–¥–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã `signal_processor`
- [ ] –ü–æ–¥–ø–∏—Å–∫–∞ —á–µ—Ä–µ–∑ `XREADGROUP`
- [ ] –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —á–µ—Ä–µ–∑ `XACK`

---

## üîπ –≠–¢–ê–ü 4: –û–ë–†–ê–ë–û–¢–ö–ê –°–ò–ì–ù–ê–õ–û–í

### ‚úÖ 4.1. –†–∞—Å–ø–∞–∫–æ–≤–∫–∞ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è
- [ ] `symbol`, `message`, `bar_time`, `sent_at`
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞:
  - —Ç–∏–∫–µ—Ä —Ä–∞–∑—Ä–µ—à—ë–Ω
  - —Ñ—Ä–∞–∑–∞ –∏–∑–≤–µ—Å—Ç–Ω–∞
  - —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –∞–∫—Ç–∏–≤–Ω—ã

### ‚úÖ 4.2. –ü–æ–∏—Å–∫ –∏ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è
- [ ] –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Å—Ç—Ä–∞—Ç–µ–≥–∏–π –ø–æ —Ñ—Ä–∞–∑–µ
- [ ] –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è (`enabled`, `archived`, `allow_open`)
- [ ] –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞: `asyncio.gather(...)`

---

## üîπ –≠–¢–ê–ü 5: –õ–û–ì–ò–†–û–í–ê–ù–ò–ï

### ‚úÖ 5.1. –õ–æ–≥ —Å–∏–≥–Ω–∞–ª–æ–≤
- [ ] UID = hash(symbol + message + bar_time)
- [ ] –í—Å—Ç–∞–≤–∫–∞ –≤ `signals_v2_log`, —Å—Ç–∞—Ç—É—Å = `new/duplicate/ignored`
- [ ] –î–ª—è –∫–∞–∂–¥–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏: –∑–∞–ø–∏—Å—å –≤ `signal_log_entries_v2`

### ‚úÖ 5.2. –°–∏—Å—Ç–µ–º–Ω—ã–π –ª–æ–≥
- [ ] –ß–µ—Ä–µ–∑ `log_system_event(...)`
- [ ] –£—Ä–æ–≤–Ω–∏: `INFO`, `WARNING`, `ERROR`

---

## üîπ –≠–¢–ê–ü 6: –£–°–¢–û–ô–ß–ò–í–û–°–¢–¨

- [ ] –û–±–µ—Ä–Ω—É—Ç—å —á–µ—Ä–µ–∑ `run_safe_loop(...)`
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∑–∞–≤–∏—Å—à–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è (`XPENDING`)
- [ ] –û—Ç—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–∏ —Å–±–æ—è—Ö Redis/PG

---

## üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï

| –ß—Ç–æ                     | –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è                          |
|-------------------------|------------------------------------------|
| –¢–∏–∫–µ—Ä—ã/—Å—Ç—Ä–∞—Ç–µ–≥–∏–∏        | –ó–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∏ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è                |
| Stream –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è   | `XADD` ‚Üí –ª–æ–≥ —Å–æ–∑–¥–∞—ë—Ç—Å—è                   |
| UID —Ä–∞–±–æ—Ç–∞–µ—Ç            | –ü–æ–≤—Ç–æ—Ä –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å         |
| –°—Ç—Ä–∞—Ç–µ–≥–∏–∏ —Ñ–∏–ª—å—Ç—Ä—É—é—Ç—Å—è   | –ê—Ä—Ö–∏–≤ –∏ allow_open —Ä–∞–±–æ—Ç–∞—é—Ç              |
| Redis –∏ PG –æ—Ç–∫–ª—é—á–∞—é—Ç—Å—è  | –°–∏—Å—Ç–µ–º–∞ –Ω–µ –ø–∞–¥–∞–µ—Ç, –ª–æ–≥–∏—Ä—É–µ—Ç —Å–±–æ–π         |

---

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç

`signals_v4_main.py`:
- —Å–ª—É—à–∞–µ—Ç Redis Stream `signals_stream`;
- —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Å–∏–≥–Ω–∞–ª—ã –ø–æ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è–º;
- –ª–æ–≥–∏—Ä—É–µ—Ç –¥–µ–π—Å—Ç–≤–∏—è –∏ –æ—à–∏–±–∫–∏;
- —É—Å—Ç–æ–π—á–∏–≤ –∫ —Å–±–æ—è–º –∏ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—é;
- –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º —á–µ—Ä–µ–∑ Consumer Groups.

---
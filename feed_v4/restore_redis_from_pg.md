# üîÑ –ú–æ–¥—É–ª—å `restore_redis_from_pg.py` ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ Redis –∏–∑ PostgreSQL

---

## üìå –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–ú–æ–¥—É–ª—å `restore_redis_from_pg.py` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ Redis –∏–∑ PostgreSQL:

- —Å–≤–µ—á–∏ M1/M5/M15 ‚Üí –≤ RedisTimeSeries;
- –∑–Ω–∞—á–µ–Ω–∏—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ ‚Üí –≤ Redis Hash.

–≠—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–æ—Å–ª–µ —Å–±—Ä–æ—Å–∞ Redis, –º–∏–≥—Ä–∞—Ü–∏–∏ –∏–ª–∏ –∑–∞–ø—É—Å–∫–∞ –Ω–æ–≤–æ–≥–æ –∏–Ω—Å—Ç–∞–Ω—Å–∞, —á—Ç–æ–±—ã –≤—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã –º–æ–≥–ª–∏ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å —Ä–∞–±–æ—Ç—É.

---

## üß± –ß—Ç–æ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç

| –û–±—ä–µ–∫—Ç        | Redis –∫–ª—é—á                  | –ò—Å—Ç–æ—á–Ω–∏–∫ –≤ PostgreSQL     |
|---------------|-----------------------------|----------------------------|
| –°–≤–µ—á–∏ M1      | `ohlcv:<symbol>:m1`         | `ohlcv4_m1`                |
| –°–≤–µ—á–∏ M5      | `ohlcv:<symbol>:m5`         | `ohlcv4_m5`                |
| –°–≤–µ—á–∏ M15     | `ohlcv:<symbol>:m15`        | `ohlcv4_m15`               |
| –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã    | `indicator:<symbol>:<tf>`   | `indicator_values_v4`     |

*`price:<symbol>` –Ω–µ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è ‚Äî –ø—Ä–∏—Ö–æ–¥—è—Ç –ø–æ WebSocket –∑–∞–Ω–æ–≤–æ.*

---

## ‚öôÔ∏è –ú–µ—Ö–∞–Ω–∏–∑–º —Ä–∞–±–æ—Ç—ã

1. –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —Å–ø–∏—Å–æ–∫ —Ç–∏–∫–µ—Ä–æ–≤ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `tickers`, –≥–¥–µ `status = 'enabled'`.
2. –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–∫–µ—Ä–∞ –∏ —Ç–∞–π–º—Ñ—Ä–µ–π–º–∞:
   - –ó–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –ø–æ—Å–ª–µ–¥–Ω–∏–µ 250 —Å–≤–µ—á–µ–π –∏–∑ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π —Ç–∞–±–ª–∏—Ü—ã PG.
   - –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è `TS.ADD` –≤ Redis.
3. –ó–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ –ø–æ `instance_id` + `symbol` + `param_name`.
   - –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è `HSET` –≤ Redis Hash.

---

## üîß –ì–¥–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è

```python
# feed_v4_main.py
await restore_redis_from_pg(pg_pool, redis)
```

‚Üí –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è **–æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —Å–∏—Å—Ç–µ–º—ã**, –¥–æ –∑–∞–ø—É—Å–∫–∞ –≤–æ—Ä–∫–µ—Ä–æ–≤.

---

## ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å

- –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—ã–∑–æ–≤ –Ω–µ –≤—Ä–µ–¥–µ–Ω: `TS.ADD` –∏ `HSET` –±–µ–∑–æ–ø–∞—Å–Ω—ã;
- –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å ¬´–≤—Å–µ–≥–¥–∞¬ª –∏–ª–∏ –ø–æ —É—Å–ª–æ–≤–∏—é:
  ```python
  if not await redis.exists("ohlcv:BTCUSDT:m1"):
      await restore_redis_from_pg(...)
  ```

---

## ‚è± –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

- –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ ~250 —Å–≤–µ—á–µ–π √ó 3 –¢–§ √ó 50 —Ç–∏–∫–µ—Ä–æ–≤ = ~37 500 –æ–ø–µ—Ä–∞—Ü–∏–π
- –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: 2‚Äì5 —Å–µ–∫—É–Ω–¥ (RedisCloud)

---

## üîê –ü–æ—á–µ–º—É —ç—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ

- Redis –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –∏—Å—Ç–æ—Ä–∏—é ‚Äî —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è;
- –ü—Ä–∏ —Å–±—Ä–æ—Å–µ Redis –≤–æ—Ä–∫–µ—Ä—ã –Ω–µ –º–æ–≥—É—Ç –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –±–µ–∑ –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö;
- –ë–µ–∑ `restore_redis_from_pg` –ø–æ—Ç—Ä–µ–±—É—é—Ç—Å—è —Ä—É—á–Ω—ã–µ –ø—Ä–∞–≤–∫–∏ –∏–ª–∏ —Å–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤—Å–µ–π —Å–∏—Å—Ç–µ–º—ã.

---

## ‚úÖ –í—ã–≤–æ–¥

–ú–æ–¥—É–ª—å `restore_redis_from_pg.py` –¥–µ–ª–∞–µ—Ç Redis:

| –°–≤–æ–π—Å—Ç–≤–æ        | –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç—Å—è |
|-----------------|----------------|
| –°–∞–º–æ–≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º—ã–º | ‚úÖ        |
| –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ã–º —Å PG     | ‚úÖ        |
| –ù–µ–∑–∞–≤–∏—Å–∏–º—ã–º –æ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è RedisCloud | ‚úÖ  |

–ó–∞–ø—É—Å–∫–∞—Ç—å –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —Å–∏—Å—Ç–µ–º—ã ‚Äî –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ.

---
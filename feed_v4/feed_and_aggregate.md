# üìÇ `feed_and_aggregate.py` ‚Äî –ø—Ä–∏—ë–º M1, –∞–≥—Ä–µ–≥–∞—Ü–∏—è, —Ç–µ–∫—É—â–∏–µ —Ü–µ–Ω—ã, –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ

---

## üìå –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

`feed_and_aggregate.py` ‚Äî —ç—Ç–æ —Ü–µ–Ω—Ç—Ä —Å–≤–µ—á–Ω–æ–≥–æ –≤–≤–æ–¥–∞ –≤ —Å–∏—Å—Ç–µ–º–µ. –û–Ω:

- –ü–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ WebSocket –¥–ª—è M1-—Å–≤–µ—á–µ–π –∏ `markPrice`,
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∫–∞–∂–¥—É—é –ø–æ–ª—É—á–µ–Ω–Ω—É—é —Å–≤–µ—á—É,
- –í—ã–ø–æ–ª–Ω—è–µ—Ç –∞–≥—Ä–µ–≥–∞—Ü–∏—é —Å—Ç–∞—Ä—à–∏—Ö —Ç–∞–π–º—Ñ—Ä–µ–π–º–æ–≤ (M5, M15 –∏ –¥—Ä.),
- –û–±–Ω–æ–≤–ª—è–µ—Ç —Ç–µ–∫—É—â–∏–µ —Ü–µ–Ω—ã –≤ Redis,
- –°–ª–µ–¥–∏—Ç –∑–∞ –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–º–∏ M1-—Å–≤–µ—á–∞–º–∏ –∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∏—Ö —á–µ—Ä–µ–∑ API,
- –ù–∏–∫–æ–≥–¥–∞ –Ω–µ —Å–æ–∑–¥–∞—ë—Ç ‚Äú–±–∏—Ç—ã–µ‚Äù –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–≤–µ—á–∏.

---

## üß± –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

### 1. üì° WebSocket –ø–æ—Ç–æ–∫–∏: `kline_1m` –∏ `markPrice`

- –ü–æ –∫–∞–∂–¥–æ–º—É —Ç–∏–∫–µ—Ä—É –æ—Ç–∫—Ä—ã–≤–∞—é—Ç—Å—è WebSocket-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:
  - `kline_1m` ‚Äî —Å–≤–µ—á–∏ M1
  - `markPrice` ‚Äî —Ç–µ–∫—É—â–∞—è —Ü–µ–Ω–∞

---

### 2. üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–≤–µ—á–µ–π M1

- –ö–∞–∂–¥–∞—è –ø—Ä–∏—à–µ–¥—à–∞—è M1-—Å–≤–µ—á–∞:
  - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ RedisTimeSeries:
    `TS.ADD ohlcv:<symbol>:m1 <ts> VALUE=<ohlcv>`
  - –î—É–±–ª–∏—Ä—É–µ—Ç—Å—è –≤ PostgreSQL (`ohlcv2_m1`)
  - –ü—É–±–ª–∏–∫—É–µ—Ç—Å—è –≤ Redis Stream `ohlcv_m1_ready`

---

### 3. üîÑ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ `markPrice` (—Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º –ø–æ —á–∞—Å—Ç–æ—Ç–µ)

- –ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ü–µ–Ω—ã —Å WebSocket:
  - –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è Redis-–∫–ª—é—á: `SET price:<symbol> <value>`

- üîí –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Redis –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç **–Ω–µ —á–∞—â–µ 1 —Ä–∞–∑–∞ –≤ —Å–µ–∫—É–Ω–¥—É**:
  - –≠—Ç–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Å–Ω–∏–∂–∞–µ—Ç –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ Redis
  - –ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ –≤—Ä–µ–º–µ–Ω–Ω—É—é –º–µ—Ç–∫—É –Ω–∞ –∫–∞–∂–¥—ã–π —Å–∏–º–≤–æ–ª
  - –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è

---

### 4. üßÆ –ê–≥—Ä–µ–≥–∞—Ü–∏—è —Å—Ç–∞—Ä—à–∏—Ö —Ç–∞–π–º—Ñ—Ä–µ–π–º–æ–≤

- –ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–∞–∂–¥–æ–π M1 –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –∑–∞–≤–µ—Ä—à—ë–Ω–Ω–æ—Å—Ç—å –ø–µ—Ä–∏–æ–¥–∞:
  - `minute % 5 == 4` ‚Üí –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞—Ç—å M5
  - `minute % 15 == 14` ‚Üí –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞—Ç—å M15

- –ê–≥—Ä–µ–≥–∞—Ü–∏—è:
  - –ó–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –ø–æ—Å–ª–µ–¥–Ω–∏–µ N —Å–≤–µ—á–µ–π –∏–∑ Redis TS
  - –°—Ç—Ä–æ–∏—Ç—Å—è –∞–≥—Ä–µ–≥–∞—Ç OHLCV
  - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ Redis + PostgreSQL
  - –ü—É–±–ª–∏–∫—É–µ—Ç—Å—è `ohlcv_<tf>_ready` –≤ Redis Stream

---

### 5. üõ† –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö M1-—Å–≤–µ—á–µ–π

- –í—Å–µ –ø—Ä–æ–ø—É—Å–∫–∏ —Ñ–∏–∫—Å–∏—Ä—É—é—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü–µ `missing_m1_log` (PostgreSQL)

- –§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞:
  - –ó–∞–≥—Ä—É–∂–∞–µ—Ç –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ —Å–≤–µ—á–∏ —á–µ—Ä–µ–∑ REST API
  - –ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏:
    - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏—Ö –∫–∞–∫ –æ–±—ã—á–Ω—É—é M1
    - –ü–æ–º–µ—á–∞–µ—Ç –∫–∞–∫ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ

#### ‚ùó –ê–≥–≥—Ä–µ–≥–∞—Ü–∏—è –ù–ï –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è, –µ—Å–ª–∏ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç M1:
- –ï—Å–ª–∏ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–π M1-—Å–≤–µ—á–∏, –∞–≥—Ä–µ–≥–∞—Ç (M5, M15) **–Ω–µ —Å–æ–∑–¥–∞—ë—Ç—Å—è**
- –ü–æ—Å–ª–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –≤—Å–µ—Ö M1, –∞–≥—Ä–µ–≥–∞—Ç—ã —Å—Ç—Ä–æ—è—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- –°–∏—Å—Ç–µ–º–∞ **–Ω–µ —Å–æ–∑–¥–∞—ë—Ç "–±–∏—Ç—ã–µ" —Å–≤–µ—á–∏**

---

## üìé –ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –º–æ–¥—É–ª–∏

- `core_io.py` ‚Äî —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
- `infra.py` ‚Äî Redis/PG, –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ, `run_safe_loop`
- `ohlcv_tools.py` ‚Äî –∞–≥—Ä–µ–≥–∞—Ç–æ—Ä—ã OHLCV

---

## üîÅ –ü—É–±–ª–∏–∫–∞—Ü–∏–∏ –∏ –∫–ª—é—á–∏

| –ü–æ—Ç–æ–∫/–∫–ª—é—á        | –ß—Ç–æ —Å–æ–¥–µ—Ä–∂–∏—Ç                          |
|-------------------|----------------------------------------|
| `ohlcv_m1_ready`  | –ù–æ–≤–∞—è M1 —Å–≤–µ—á–∞                         |
| `ohlcv_m5_ready`  | –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å M5                          |
| `ohlcv_m15_ready` | –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å M15                         |
| `price:<symbol>`  | –ü–æ—Å–ª–µ–¥–Ω—è—è —Ü–µ–Ω–∞ markPrice (–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è ‚â§1/—Å–µ–∫) |

---

## üß† –ó–Ω–∞—á–µ–Ω–∏–µ –≤ —Å–∏—Å—Ç–µ–º–µ

| –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                 | –î–∞ |
|----------------------------|----|
| –ü—Ä–∏—ë–º —Å–≤–µ—á–µ–π M1            | ‚úÖ |
| –ü–æ–¥–¥–µ—Ä–∂–∫–∞ markPrice        | ‚úÖ |
| –ê–≥—Ä–µ–≥–∞—Ü–∏—è —Å—Ç–∞—Ä—à–∏—Ö –¢–§       | ‚úÖ |
| –ü—É–±–ª–∏–∫–∞—Ü–∏—è –≤ Redis Streams | ‚úÖ |
| –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–µ–ª–æ–≤    | ‚úÖ |
| –ó–∞—â–∏—Ç–∞ –æ—Ç –±–∏—Ç—ã—Ö –¥–∞–Ω–Ω—ã—Ö     | ‚úÖ |

---
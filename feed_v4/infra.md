# üß± `infra.py` ‚Äî –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–π –º–æ–¥—É–ª—å —Å–∏—Å—Ç–µ–º—ã

–§–∞–π–ª `infra.py` –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Redis –∏ PostgreSQL, –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –æ—Ç–ª–∞–¥–æ—á–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞, –∑–∞—â–∏—Ç—É —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á –∏ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ, –º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ.

---

## üìå –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

- –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Redis –∏ PostgreSQL
- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (–∏–∑ Render)
- –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ —É—Ç–∏–ª–∏—Ç—ã:
  - `run_safe_loop()` ‚Äî –∑–∞—â–∏—Ç–∞ –æ—Ç —Å–±–æ–µ–≤
  - `logging` ‚Äî –≥–∏–±–∫–∞—è —Å–∏—Å—Ç–µ–º–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —Å —Ü–≤–µ—Ç–∞–º–∏ –∏ —É—Ä–æ–≤–Ω—è–º–∏
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–æ –≤—Å–µ—Ö –∫–ª—é—á–µ–≤—ã—Ö –º–æ–¥—É–ª—è—Ö —Å–∏—Å—Ç–µ–º—ã

---

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### üîπ –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (—á–µ—Ä–µ–∑ Render)

```python
REDIS_URL = os.getenv("REDIS_URL")
POSTGRES_URL = os.getenv("POSTGRES_URL")
DEBUG_MODE = os.getenv("DEBUG_MODE", "false").lower() == "true"
```

- –ù–∏–∫–∞–∫–∏—Ö `.env` —Ñ–∞–π–ª–æ–≤ ‚Äî —Ç–æ–ª—å–∫–æ Render ‚Üí Environment Variables

---

## üîå –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è

### Redis

```python
def init_redis_client():
    return aioredis.from_url(
        REDIS_URL,
        decode_responses=True,
        encoding="utf-8"
    )
```

### PostgreSQL

```python
async def init_pg_pool():
    return await asyncpg.create_pool(POSTGRES_URL)
```

---

## üß± –ó–∞—â–∏—Ç–∞ —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á

### `run_safe_loop(...)`

```python
def run_safe_loop(coro_fn, name: str, retry_delay: int = 5)
```

- –û–±–æ—Ä–∞—á–∏–≤–∞–µ—Ç –ª—é–±–æ–π –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π –≤–æ—Ä–∫–µ—Ä
- –õ–æ–≥–∏—Ä—É–µ—Ç –æ—à–∏–±–∫–∏, –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç —á–µ—Ä–µ–∑ `retry_delay`

---

## üßæ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### –£—Ä–æ–≤–Ω–∏:

- `DEBUG`: –ø–æ–¥—Ä–æ–±–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–µ—Å–ª–∏ `DEBUG_MODE = true`)
- `INFO`: —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è (–∑–∞–ø—É—Å–∫, –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∏ —Ç.–ø.)
- `WARNING`: –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è, –Ω–æ –±–µ–∑ –æ—à–∏–±–∫–∏
- `ERROR`: –æ—à–∏–±–∫–∞, –Ω–æ –ø—Ä–æ—Ü–µ—Å—Å –∂–∏–≤
- `CRITICAL`: —Å–µ—Ä—å—ë–∑–Ω—ã–µ —Å–±–æ–∏

### –¶–≤–µ—Ç–∞ (–¥–ª—è —Ç–µ—Ä–º–∏–Ω–∞–ª–∞):

| –£—Ä–æ–≤–µ–Ω—å     | –¶–≤–µ—Ç        |
|-------------|-------------|
| DEBUG       | –°–µ—Ä—ã–π       |
| INFO        | –ó–µ–ª—ë–Ω—ã–π     |
| WARNING     | –ñ—ë–ª—Ç—ã–π      |
| ERROR       | –ö—Ä–∞—Å–Ω—ã–π     |
| CRITICAL    | –ö—Ä–∞—Å–Ω—ã–π —Ñ–æ–Ω |

### –§–æ—Ä–º–∞—Ç –ª–æ–≥–æ–≤:

```
2025-05-16 13:44:21 | INFO     | AGGREGATOR | –ê–≥—Ä–µ–≥–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞: BTCUSDT / M15
```

### –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:

```python
import logging
log = logging.getLogger("INDICATORS")
log.info("EMA(9) —Ä–∞—Å—Å—á–∏—Ç–∞–Ω")
log.warning("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å–≤–µ—á–µ–π –¥–ª—è RSI(14)")
```

---

## üìé –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤

- `feed_v4_main.py`
- `feed_and_aggregate.py`
- `indicators_main.py`
- `snapshot.py`
- –≤—Å–µ—Ö –ø–ª–∞–≥–∏–Ω–∞—Ö –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤

---

## ‚úÖ –†–µ–∑—é–º–µ

- `infra.py` ‚Äî —ç—Ç–æ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π —Ü–µ–Ω—Ç—Ä —Å–∏—Å—Ç–µ–º—ã
- –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –∑–∞–ø—É—Å–∫, –¥–æ—Å—Ç—É–ø –∫ –¥–∞–Ω–Ω—ã–º –∏ —á–∏—Ç–∞–µ–º—ã–π –≤—ã–≤–æ–¥
- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –µ–¥–∏–Ω–∞—è, —á–µ—Ä–µ–∑ Render
- –î–µ–ª–∞–µ—Ç –ø—Ä–æ–µ–∫—Ç –≥–∏–±–∫–∏–º, —Ä–∞—Å—à–∏—Ä—è–µ–º—ã–º –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–º

---
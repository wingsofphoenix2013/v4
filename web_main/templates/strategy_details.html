<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–°—Ç—Ä–∞—Ç–µ–≥–∏–∏</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        background: linear-gradient(to bottom right, #e0f2ff, #fde2e4);
      }
    </style>
  </head>
  <body class="min-h-screen font-sans text-slate-800">
    <!-- –í–µ—Ä—Ö–Ω–µ–µ –º–µ–Ω—é –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ -->
    <header class="w-full bg-white/80 backdrop-blur-md shadow-sm sticky top-0 z-50">
      <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
        <h1 class="text-2xl font-semibold text-blue-900 tracking-wide">–¢–æ—Ä–≥–æ–≤—ã–π –î–≤–∏–∂–æ–∫ v4</h1>
        <nav class="space-x-4 text-sm font-medium text-slate-700">
          <a href="/" class="hover:text-blue-600 transition-colors">–ì–ª–∞–≤–Ω–∞—è</a>
          <a href="/tickers" class="hover:text-blue-600 transition-colors">–¢–∏–∫–µ—Ä—ã</a>
          <a href="/indicators" class="hover:text-blue-600 transition-colors">–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã</a>
          <a href="/signals" class="hover:text-blue-600 transition-colors">–°–∏–≥–Ω–∞–ª—ã</a>
          <a href="/strategies" class="hover:text-blue-600 transition-colors">–°—Ç—Ä–∞—Ç–µ–≥–∏–∏</a>
          <a href="/trades" class="hover:text-blue-600 transition-colors">–¢–æ—Ä–≥–∏</a>
          <a href="/status" class="hover:text-blue-600 transition-colors">–°—Ç–∞—Ç—É—Å</a>
        </nav>
      </div>
    </header>
<!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–Ω–æ–ø–æ–∫ –∏ —Ç–∞–±–ª–∏—Ü—ã -->
<main class="max-w-7xl mx-auto px-4 py-10">
  <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
<div class="flex justify-between items-center mb-6">
  <a href="/strategies?filter={{ filter }}" class="px-5 py-2 bg-slate-200 hover:bg-slate-300 text-slate-800 rounded-lg font-medium text-sm">
    ‚Üê –ù–∞–∑–∞–¥
  </a>
</div>

<div class="grid grid-cols-1 gap-6">
  <!-- –ö–∞—Ä—Ç–æ—á–∫–∞: –°—Ç—Ä–∞—Ç–µ–≥–∏—è -->
  <div class="w-full bg-white/80 rounded-xl shadow p-6 mb-4">
    <h2 class="text-lg font-semibold text-slate-700 mb-3">–°—Ç—Ä–∞—Ç–µ–≥–∏—è</h2>
    <!-- —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –ø–æ–∑–∂–µ -->
  </div>
<!-- –ö–∞—Ä—Ç–æ—á–∫–∞: –ö–∞–∑–Ω–∞—á–µ–π—Å—Ç–≤–æ -->
<div class="w-full bg-white/80 rounded-xl shadow p-6 mb-4">
  {% if treasury %}
    {% set available = treasury.pnl_operational - reserve_required %}
    <div class="flex justify-between items-center mb-3">
      <h2 class="text-lg font-semibold text-slate-700">–ö–∞–∑–Ω–∞—á–µ–π—Å—Ç–≤–æ</h2>

      <div class="flex gap-2 items-center" id="withdraw-container">
        {% if available > 0 %}
          <input type="number"
                 id="withdraw-input"
                 placeholder="–°—É–º–º–∞"
                 min="0.01"
                 step="0.01"
                 class="hidden px-3 py-1.5 text-sm rounded-md border border-slate-300 focus:outline-none focus:ring-2 focus:ring-blue-400"
                 oninput="validateAmount(this, {{ available | round(2) }})">
        {% endif %}

        {% if available > 0 %}
          <button id="withdraw-button"
                  class="px-4 py-1.5 bg-green-600 hover:bg-green-700 text-white text-sm rounded-lg font-medium"
                  onclick="handleWithdrawClick({{ available | round(2) }})">
            –°–Ω—è—Ç—å –∫–∞—Å—Å—É
          </button>
        {% endif %}

        <button class="px-4 py-1.5 bg-purple-600 hover:bg-purple-700 text-white text-sm rounded-lg font-medium">
          –î–æ–±–∞–≤–∏—Ç—å –¥–µ–ø–æ–∑–∏—Ç
        </button>
      </div>
    </div>

    <table class="w-full table-auto rounded-xl overflow-hidden mb-6">
      <thead class="bg-slate-100 text-slate-700 text-center text-sm uppercase">
        <tr>
          <th class="py-2">–ü—Ä–∏–±—ã–ª—å</th>
          <th class="py-2">–ö–∞—Å—Å–∞</th>
          <th class="py-2">–°—Ç—Ä–∞—Ö–æ–≤–∫–∞</th>
          <th class="py-2">–î–æ—Å—Ç—É–ø–Ω–æ</th>
        </tr>
      </thead>
      <tbody class="text-slate-800 text-sm divide-y divide-slate-200 text-center">
        <tr>
          <td class="py-2">$ {{ treasury.pnl_total | round(2) }}</td>
          <td class="py-2">$ {{ treasury.pnl_operational | round(2) }}</td>
          <td class="py-2">$ {{ treasury.pnl_insurance | round(2) }}</td>
          <td class="py-2">
            {% if available > 0 %}
              <span class="text-green-600 font-semibold">$ {{ available | round(2) }}</span>
            {% else %}
              <span class="text-red-500">–°–Ω—è—Ç–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ</span>
            {% endif %}
          </td>
        </tr>
      </tbody>
    </table>
  {% endif %}
<h2 class="text-lg font-semibold text-slate-700 mb-3">–ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π</h2>
  <table class="w-full table-auto rounded-xl overflow-hidden mb-4">
    <thead class="bg-slate-100 text-slate-700 text-left text-sm uppercase">
      <tr>
        <th class="px-4 py-3">‚Ññ</th>
        <th class="px-4 py-3">–í—Ä–µ–º—è</th>
        <th class="px-4 py-3">–°—Ü–µ–Ω–∞—Ä–∏–π</th>
        <th class="px-4 py-3">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
      </tr>
    </thead>
    <tbody class="text-slate-800 text-sm divide-y divide-slate-200">
      {% for row in treasury_log %}
      <tr class="hover:bg-slate-100">
        <td class="px-4 py-3">{{ loop.index + ((page - 1) * log_limit) }}</td>
        <td class="px-4 py-3 font-mono">{{ row.timestamp | format_date_ru }}</td>
        <td class="px-4 py-3">{{ row.scenario }}</td>
        <td class="px-4 py-3 whitespace-pre-wrap">{{ row.comment | highlight_amounts | safe }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  {% set total_pages = (log_total // log_limit) + (1 if log_total % log_limit > 0 else 0) %}
  {% if total_pages > 1 %}
  <div class="flex justify-center gap-2">
    {% for p in range(1, total_pages + 1) %}
      <a href="?filter={{ filter }}&page={{ p }}"
         class="px-3 py-1 rounded-md text-sm font-medium
                {{ 'bg-blue-600 text-white' if p == page else 'bg-slate-200 hover:bg-slate-300 text-slate-700' }}">
        {{ p }}
      </a>
    {% endfor %}
  </div>
  {% endif %}
</div>
  <!-- –ö–∞—Ä—Ç–æ—á–∫–∞: –¢–æ—Ä–≥–æ–≤–ª—è -->
  <div class="w-full bg-white/80 rounded-xl shadow p-6 mb-4">
    <h2 class="text-lg font-semibold text-slate-700 mb-3">–¢–æ—Ä–≥–æ–≤–ª—è</h2>
    <!-- —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –ø–æ–∑–∂–µ -->
  </div>

  <!-- –ö–∞—Ä—Ç–æ—á–∫–∞: –°–ª—É–∂–µ–±–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
  <div class="w-full bg-white/80 rounded-xl shadow p-6 mb-4">
    <h2 class="text-lg font-semibold text-slate-700 mb-3">–°–ª—É–∂–µ–±–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h2>
    <!-- —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –ø–æ–∑–∂–µ -->
  </div>
</div>
</main>
<script>
let withdrawActive = false;

function handleWithdrawClick(maxAvailable) {
  const input = document.getElementById("withdraw-input");
  const button = document.getElementById("withdraw-button");

  if (!withdrawActive) {
    input.classList.remove("hidden");
    input.focus();
    button.textContent = "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —Å–Ω—è—Ç–∏–µ";  // üü¢ –≤–æ—Ç —ç—Ç–∞ —Å—Ç—Ä–æ–∫–∞ –º–µ–Ω—è–µ—Ç —Ç–µ–∫—Å—Ç
    withdrawActive = true;
  } else {
    const value = parseFloat(input.value);
    if (isNaN(value) || value <= 0) {
      alert("–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –¥–ª—è —Å–Ω—è—Ç–∏—è");
      return;
    }
    if (value > maxAvailable) {
      alert(`–î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ ${maxAvailable.toFixed(2)}`);
      return;
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    fetch(window.location.pathname + "/withdraw", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ amount: value })
    }).then(res => {
      if (res.ok) {
        window.location.reload();
      } else {
        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –æ–ø–µ—Ä–∞—Ü–∏–∏");
      }
    });
  }
}

function validateAmount(input, max) {
  const val = parseFloat(input.value);
  if (val > max) {
    input.classList.add("border-red-500", "ring-red-500");
  } else {
    input.classList.remove("border-red-500", "ring-red-500");
  }
}
</script>
</body>
</html>
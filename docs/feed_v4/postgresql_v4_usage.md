# üß† PostgreSQL –≤ —Å–∏—Å—Ç–µ–º–µ ‚Äî –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤, –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è, –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π

---

## üìå –†–æ–ª—å PostgreSQL

PostgreSQL ‚Äî —ç—Ç–æ **—Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–µ –¥–æ–ª–≥–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ** –≤—Å–µ–π —Å–∏—Å—Ç–µ–º—ã. –í –æ—Ç–ª–∏—á–∏–µ –æ—Ç Redis, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Ä–æ–ª—å –±—ã—Å—Ç—Ä–æ–≥–æ –∫–µ—à–∞ –∏ –±—Ä–æ–∫–µ—Ä–∞ —Å–æ–±—ã—Ç–∏–π, PostgreSQL:

- —Ö—Ä–∞–Ω–∏—Ç –≤—Å–µ —Å–≤–µ—á–∏ (M1, M5, M15) –±–µ–∑ –ø–æ—Ç–µ—Ä—å;
- —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ–ª–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤;
- —É–ø—Ä–∞–≤–ª—è–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ä–∞—Å—á—ë—Ç–æ–≤;
- —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ —Å–≤–µ—á–∏ –∏ –æ—à–∏–±–∫–∏.

–≠—Ç–æ ‚Äî —Ç–æ—á–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∏ –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã.

---

## ‚öôÔ∏è –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î

–í —Å–∏—Å—Ç–µ–º–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ `asyncpg.create_pool()`**:

```python
pg_pool = await asyncpg.create_pool(
    POSTGRES_URL,
    min_size=5,
    max_size=20,
    timeout=10
)
```

### –ü–æ—á–µ–º—É –ø—É–ª –≤–∞–∂–µ–Ω:
- –ò–∑–±–µ–≥–∞–µ—Ç –∑–∞—Ç—Ä–∞—Ç –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π;
- –ü–æ–∑–≤–æ–ª—è–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –¥–æ 20 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö SQL-–∑–∞–ø—Ä–æ—Å–æ–≤ –±–µ–∑ –∑–∞–¥–µ—Ä–∂–µ–∫;
- –ü–µ—Ä–µ–¥–∞—ë—Ç—Å—è –≤ –∫–∞–∂–¥—ã–π –≤–æ—Ä–∫–µ—Ä (`feed`, `aggregator`, `indicators`).

---

## üîÅ –ö–∞–∫ –∏ –∫–æ–≥–¥–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∑–∞–ø–∏—Å—å –≤ –ë–î

### –°–≤–µ—á–∏ M1:
- –°—Ä–∞–∑—É –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è —Å WebSocket.
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `INSERT ... ON CONFLICT DO UPDATE` –¥–ª—è idempotent-–∑–∞–ø–∏—Å–∏.

### –°–≤–µ—á–∏ M5/M15:
- –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ –∏ —É—Å–ø–µ—à–Ω–æ–π –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ –∏–∑ Redis TS.
- –ü–∏—à—É—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –≤—Å–µ—Ö –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö M1.

### –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã:
- –°—á–∏—Ç–∞—é—Ç—Å—è –≤ `indicators_main.py` –ø–æ –∫–∞–∂–¥–æ–π –≥–æ—Ç–æ–≤–æ–π —Å–≤–µ—á–µ M5/M15.
- –ó–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –ø–æ—à—Ç—É—á–Ω–æ, –Ω–∞–ø—Ä—è–º—É—é –≤ —Ç–∞–±–ª–∏—Ü—É —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏.

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:
- –ó–∞–¥–∞—é—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ —á–µ—Ä–µ–∑ `indicator_instances` –∏ `indicator_parameters`.

### –û—à–∏–±–∫–∏ –∏ —Å–æ–±—ã—Ç–∏—è:
- –ß–µ—Ä–µ–∑ –ª–æ–≥–≥–µ—Ä (`system_log_v4`) ‚Äî –¥–ª—è –∞—É–¥–∏—Ç–∞ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞.

---

## üîß –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Å–∫–æ—Ä–æ—Å—Ç–∏ –∑–∞–ø–∏—Å–∏

### ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `executemany` –¥–ª—è batch –≤—Å—Ç–∞–≤–æ–∫

**–ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –≤:**
- –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ M1 (`repair_missing_m1`)
- –∑–∞–≥—Ä—É–∑–∫–µ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö
- —Ä—É—á–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏

**–ü—Ä–∏–º–µ—Ä:**
```python
await conn.executemany(
    "INSERT INTO ohlcv4_m1 (...) VALUES (...) ON CONFLICT DO UPDATE ...",
    list_of_tuples
)
```

üìå –ü–æ–∑–≤–æ–ª—è–µ—Ç –≤—Å—Ç–∞–≤–ª—è—Ç—å –¥–µ—Å—è—Ç–∫–∏ –∑–∞–ø–∏—Å–µ–π –∑–∞ –æ–¥–∏–Ω round-trip –∫ –ë–î.

---

## ‚õî –ì–¥–µ batch **–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ**

### –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã:
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ –≤ —Ä–∞–º–∫–∞—Ö —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏;
- –ö–∞–∂–¥—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–∏—à–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ (–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ).

---

## üìã –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ–º

- –í—Å–µ —Ç–∞–±–ª–∏—Ü—ã –∏–º–µ—é—Ç `PRIMARY KEY` –∏–ª–∏ `UNIQUE` –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö –≤—Å—Ç–∞–≤–æ–∫;
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `ON CONFLICT DO NOTHING` –∏–ª–∏ `DO UPDATE` –¥–ª—è idempotent-–≤—Å—Ç–∞–≤–∫–∏;
- –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –∏–ª–∏ —Å–±–æ–∏ –Ω–µ –ø—Ä–∏–≤–µ–¥—É—Ç –∫ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—é –¥–∞–Ω–Ω—ã—Ö.

---

## üß† PostgreSQL –∫–∞–∫ —Ç–æ—á–∫–∞ –ø—Ä–∞–≤–¥—ã

- Redis –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–±—Ä–æ—à–µ–Ω;
- –ë–∏–∑–Ω–µ—Å-–≤–æ—Ä–∫–µ—Ä—ã –º–æ–≥—É—Ç –±—ã—Ç—å –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω—ã;
- –ù–æ PostgreSQL –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç:
  - –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –∏—Å—Ç–æ—Ä–∏–∏;
  - –¥–æ—Å—Ç—É–ø –∫ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞–º –∑–∞–¥–Ω–∏–º —á–∏—Å–ª–æ–º;
  - –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Ä–µ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è (–µ—Å–ª–∏ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ Redis –∏–ª–∏ UI).

---

## ‚úÖ –í—ã–≤–æ–¥

| –ü—Ä–∏–Ω—Ü–∏–ø                          | –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ? |
|----------------------------------|--------------|
| –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –ø—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π       |           |
| Idempotent-–∑–∞–ø–∏—Å—å (`ON CONFLICT`)|             |
| Batch –≤—Å—Ç–∞–≤–∫–∏ —Ç–∞–º, –≥–¥–µ –Ω—É–∂–Ω–æ     |             |
| –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ     |             |
| –ò–∑–æ–ª—è—Ü–∏—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–∏—Ö —Ä–∞—Å—á—ë—Ç–æ–≤|             |

PostgreSQL —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ **—Å–ø–æ–∫–æ–π–Ω—ã–π, –Ω–æ –Ω–∞–¥—ë–∂–Ω—ã–π —è–∫–æ—Ä—å** –≤—Å–µ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã.

---
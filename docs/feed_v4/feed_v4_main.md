## üß† –ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ `feed_v4_main.py`

–§–∞–π–ª `feed_v4_main.py` ‚Äî —ç—Ç–æ **—Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞** –¥–ª—è –≤—Å–µ–π —Å–∏—Å—Ç–µ–º—ã. –û–Ω –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏, –Ω–æ –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Ä–æ–ª—å **–¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞**, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É—è –∏ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –æ—Å–Ω–æ–≤–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤.

---

### üìå –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

- –ó–∞–ø—É—Å–∫–∞–µ—Ç –≤—Å–µ –∫–ª—é—á–µ–≤—ã–µ –≤–æ—Ä–∫–µ—Ä—ã: –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–≤–µ—á–µ–π, –∞–≥—Ä–µ–≥–∞—Ü–∏—è, —Ä–∞—Å—á—ë—Ç –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤, snapshot.
- –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∑–∞—â–∏—Ç—É –æ—Ç —Å–±–æ–µ–≤ (`run_safe_loop`) ‚Äî –∑–∞–¥–∞—á–∏ –Ω–µ "–ø–∞–¥–∞—é—Ç –Ω–∞–≤—Å–µ–≥–¥–∞".
- –ü–æ–¥–∫–ª—é—á–∞–µ—Ç –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã: Redis, PostgreSQL.
- –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –µ–¥–∏–Ω—ã–π `asyncio` event loop.

---

### ‚öôÔ∏è –û—Å–Ω–æ–≤–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è

1. **–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π:**
   - `init_pg_pool()` ‚Üí PostgreSQL
   - `init_redis_client()` ‚Üí Redis (RedisCloud Essentials)
   - –ó–∞–≥—Ä—É–∑–∫–∞ in-memory –∫—ç—à–∞, –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ ‚Äî –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–∑ PG.

2. **–ó–∞–ø—É—Å–∫ –∑–∞–¥–∞—á –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ:**
   –í—Å–µ –æ—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –∫–∞–∫ `asyncio.Task`:
   - `run_feed_and_aggregator(pg, redis)` ‚Äî –ø–æ–ª—É—á–µ–Ω–∏–µ M1 –∏ –∞–≥—Ä–µ–≥–∞—Ü–∏—è M5/M15.
   - `run_indicator_worker(pg, redis)` ‚Äî –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ `ohlcv_m5_ready`, `ohlcv_m15_ready` –∏ —Ä–∞—Å—á—ë—Ç –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤.
   - `run_snapshot_loop(pg, redis)` ‚Äî —Ä–µ–≥—É–ª—è—Ä–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è.

3. **–ó–∞—â–∏—Ç–∞ –≤–æ—Ä–∫–µ—Ä–æ–≤:**
   –í—Å–µ –∑–∞–¥–∞—á–∏ –æ–±—ë—Ä–Ω—É—Ç—ã –≤ `run_safe_loop(...)`:
   - –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞—é—Ç—Å—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è
   - –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –ø—Ä–∏ —Å–±–æ–µ —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º

4. **–û—Ç–ª–∞–¥–æ—á–Ω—ã–π —Ä–µ–∂–∏–º:**
   - –£–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Ñ–ª–∞–≥–æ–º `DEBUG_MODE` –∏–∑ `debug_utils.py`
   - –ü—Ä–∏ –≤–∫–ª—é—á–µ–Ω–∏–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –æ—Ç–ª–∞–¥–æ—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (`debug_log()`)

5. **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º:**
   - –í—ã–∑–æ–≤ `asyncio.run(main())` ‚Äî —Å—Ç–∞—Ä—Ç —Å–∏—Å—Ç–µ–º—ã
   - –ü–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–ø—Ä–∞–≤–ª—è—Ç—å event loop —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ

---

### üß± –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤—ã–∑–æ–≤–∞

```python
await asyncio.gather(
    run_safe_loop(lambda: run_feed_and_aggregator(pg, redis), "FEED+AGGREGATOR"),
    run_safe_loop(lambda: run_indicator_worker(pg, redis), "INDICATORS"),
    run_safe_loop(lambda: run_snapshot_loop(pg, redis), "SNAPSHOT"),
)
```

---

### üìä –ü–æ—á–µ–º—É —ç—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ

- –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑—É–µ—Ç –∑–∞–ø—É—Å–∫ –∏ –∫–æ–Ω—Ç—Ä–æ–ª—å –≤—Å–µ—Ö –∑–∞–¥–∞—á
- –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å —Å–∏—Å—Ç–µ–º—ã
- –ü–æ–∑–≤–æ–ª—è–µ—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ
- –î–µ–ª–∞–µ—Ç –∫–æ–¥ –º–æ–¥—É–ª—å–Ω—ã–º, –Ω–æ —É–ø—Ä–∞–≤–ª—è–µ–º—ã–º

---